{% extends "base.html" %}

{% block title %}Analysis Results - ResumeAnalyser{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <h1 class="display-6 fw-bold">
                <i class="bi bi-file-earmark-text"></i> Resume Analysis
            </h1>
        </div>
    </div>

    <div id="analysisContent" class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading analysis results...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const resumeId = window.location.pathname.split('/').pop();

async function loadAnalysis() {
    try {
        const response = await fetch(`/analysis/${resumeId}`);
        const data = await response.json();
        
        if (response.ok) {
            displayAnalysis(data);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError(error.message);
    }
}

function displayAnalysis(data) {
    const analysis = data.analysis;
    const loadingState = document.getElementById('loadingState');
    loadingState.style.display = 'none';
    
    const content = document.getElementById('analysisContent');
    
    let html = `
        <div class="col-lg-10 mx-auto">
            <!-- Header Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">${data.filename}</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Uploaded:</strong> ${new Date(data.uploaded_at).toLocaleString()}</p>
                            <p class="mb-0"><strong>Analyzed:</strong> ${new Date(data.analyzed_at).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="overall-score">
                                <h2 class="text-primary mb-0">${analysis.overall_score || 0}/100</h2>
                                <p class="text-muted small mb-0">Overall Score</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Info -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-person-fill text-primary"></i> Personal Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> ${analysis.personal_info.name}</p>
                            <p><strong>Email:</strong> ${analysis.personal_info.email}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Phone:</strong> ${analysis.personal_info.phone}</p>
                            <p><strong>Location:</strong> ${analysis.personal_info.location || 'Not Found'}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-file-text text-primary"></i> Professional Summary</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">${analysis.summary}</p>
                </div>
            </div>

            <!-- Skills -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-tools text-primary"></i> Skills</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        ${analysis.skills.map(skill => `
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">${skill}</span>
                        `).join('')}
                    </div>
                    ${analysis.skills.length === 0 ? '<p class="text-muted mb-0">No skills extracted</p>' : ''}
                </div>
            </div>

            <!-- Skills Chart -->
            ${analysis.skills.length > 0 ? `
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-bar-chart text-primary"></i> Top Skills Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="skillsChart" height="80"></canvas>
                </div>
            </div>
            ` : ''}

            <!-- Education -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-mortarboard-fill text-primary"></i> Education</h5>
                </div>
                <div class="card-body">
                    ${analysis.education.length > 0 ? analysis.education.map(edu => `
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="fw-bold">${edu.degree}</h6>
                            <p class="mb-1 text-muted">${edu.institution}</p>
                            <p class="mb-1"><small><i class="bi bi-calendar"></i> ${edu.year}</small></p>
                            ${edu.details ? `<p class="mb-0 small">${edu.details}</p>` : ''}
                        </div>
                    `).join('') : '<p class="text-muted mb-0">No education information found</p>'}
                </div>
            </div>

            <!-- Experience -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-briefcase-fill text-primary"></i> Experience</h5>
                </div>
                <div class="card-body">
                    ${analysis.experience.length > 0 ? analysis.experience.map(exp => `
                        <div class="mb-4 pb-3 border-bottom">
                            <h6 class="fw-bold">${exp.title}</h6>
                            <p class="mb-2 text-muted">${exp.company} | ${exp.duration}</p>
                            ${exp.responsibilities && exp.responsibilities.length > 0 ? `
                                <ul class="small">
                                    ${exp.responsibilities.map(resp => `<li>${resp}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('') : '<p class="text-muted mb-0">No experience information found</p>'}
                </div>
            </div>

            <!-- Certifications -->
            ${analysis.certifications && analysis.certifications.length > 0 ? `
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-award-fill text-primary"></i> Certifications</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        ${analysis.certifications.map(cert => `
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>${cert}</li>
                        `).join('')}
                    </ul>
                </div>
            </div>
            ` : ''}

            <!-- Strengths and Improvements -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-success bg-opacity-10 py-3">
                            <h5 class="mb-0 text-success"><i class="bi bi-star-fill"></i> Strengths</h5>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${analysis.strengths && analysis.strengths.length > 0 ? 
                                    analysis.strengths.map(s => `<li>${s}</li>`).join('') :
                                    '<li class="text-muted">No strengths identified</li>'
                                }
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-warning bg-opacity-10 py-3">
                            <h5 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Areas for Improvement</h5>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${analysis.areas_for_improvement && analysis.areas_for_improvement.length > 0 ? 
                                    analysis.areas_for_improvement.map(a => `<li>${a}</li>`).join('') :
                                    '<li class="text-muted">No specific areas identified</li>'
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggestions -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-lightbulb-fill text-primary"></i> Suggestions to Improve</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        ${analysis.suggestions.map(suggestion => `<li class="mb-2">${suggestion}</li>`).join('')}
                    </ol>
                </div>
            </div>

            <!-- Job Match (if available) -->
            ${analysis.job_match ? `
            <div class="card shadow-sm border-0 mb-4 border-primary">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-bullseye"></i> Job Match Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h2 class="display-4 text-primary mb-0">${analysis.job_match.score}%</h2>
                        <p class="text-muted">Match Score</p>
                        <canvas id="matchChart" width="200" height="200"></canvas>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-success"><i class="bi bi-check-circle"></i> Matching Skills</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${analysis.job_match.matching_skills.map(skill => `
                                    <span class="badge bg-success">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-danger"><i class="bi bi-x-circle"></i> Missing Skills</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${analysis.job_match.missing_skills.map(skill => `
                                    <span class="badge bg-danger">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="bi bi-briefcase"></i> Experience Match</h6>
                        <p class="mb-3">${analysis.job_match.experience_match}</p>
                        
                        <h6><i class="bi bi-lightbulb"></i> Recommendations</h6>
                        <ul class="mb-0">
                            ${analysis.job_match.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    content.innerHTML = html;
    
    // Create charts if data is available
    if (analysis.skills.length > 0) {
        createSkillsChart(analysis.skills);
    }
    
    if (analysis.job_match) {
        createMatchChart(analysis.job_match.score);
    }
}

function createSkillsChart(skills) {
    const ctx = document.getElementById('skillsChart');
    if (!ctx) return;
    
    // Take top 10 skills
    const topSkills = skills.slice(0, 10);
    
    new Chart(ctx, {
        type: 'bar',data: {
            labels: topSkills,
            datasets: [{
                label: 'Skills',
                data: topSkills.map(() => Math.floor(Math.random() * 30) + 70), // Mock proficiency
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Proficiency %'
                    }
                }
            }
        }
    });
}

function createMatchChart(score) {
    const ctx = document.getElementById('matchChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Match', 'Gap'],
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(220, 53, 69, 0.3)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function showError(message) {
    const loadingState = document.getElementById('loadingState');
    loadingState.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Error loading analysis: ${message}
        </div>
    `;
}

// Load analysis on page load
loadAnalysis();
</script>
{% endblock %}